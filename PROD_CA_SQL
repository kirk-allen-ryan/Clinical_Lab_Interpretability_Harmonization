SELECT
  CV_FAC_HIST.DISPLAY,
  ENCOUNTER.ENCNTR_ID,
  pi_from_gmt(ENCOUNTER.REG_DT_TM,( @Prompt('Choose Time Zone','A','Relative Dates\TZ Prompt List',mono,free,persistent,{' '},) )),
  pi_from_gmt(ENCOUNTER.DISCH_DT_TM,( @Prompt('Choose Time Zone','A','Relative Dates\TZ Prompt List',mono,free,persistent,{' '},) )),
  CV_EVENT.DISPLAY,
  CLINICAL_EVENT.RESULT_VAL,
  pi_from_gmt(CLINICAL_EVENT.EVENT_END_DT_TM,( @Prompt('Choose Time Zone','A','Relative Dates\TZ Prompt List',mono,free,persistent,{' '},) ))
,
  CLINICAL_EVENT.NORMAL_LOW,
  CLINICAL_EVENT.NORMAL_HIGH,
  CV_CAT.DISPLAY,
  CV_RES_GRP_SEC.DISPLAY,
  CV_SERV_RES.DISPLAY
FROM
  CODE_VALUE  CV_FAC_HIST,
  ENCNTR_LOC_HIST,
  ENCOUNTER,
  CODE_VALUE  CV_EVENT,
  CLINICAL_EVENT,
  CODE_VALUE  CV_CAT,
  RESOURCE_GROUP  RESOURCE_GROUP_SUB,
  RESOURCE_GROUP  RESOURCE_GROUP_SEC,
  CODE_VALUE  CV_RES_GRP_SEC,
  CODE_VALUE  CV_SERV_RES,
  CODE_VALUE  CV_ENCOUTER_TYPE,
  ORDERS  ORDERS_CE
WHERE
  ( ENCOUNTER.ENCNTR_TYPE_CD=CV_ENCOUTER_TYPE.CODE_VALUE AND ENCOUNTER.ACTIVE_IND = 1  )
  AND  ( ENCOUNTER.ENCNTR_ID=ENCNTR_LOC_HIST.ENCNTR_ID AND ENCOUNTER.ACTIVE_IND = 1  )
  AND  ( ENCNTR_LOC_HIST.LOC_FACILITY_CD=CV_FAC_HIST.CODE_VALUE  )
  AND  ( CLINICAL_EVENT.EVENT_CD=CV_EVENT.CODE_VALUE  )
  AND  ( ENCOUNTER.ENCNTR_ID=CLINICAL_EVENT.ENCNTR_ID AND ENCOUNTER.ACTIVE_IND = 1 AND ENCOUNTER.PERSON_ID = CLINICAL_EVENT.PERSON_ID  )
  AND  ( ORDERS_CE.CATALOG_CD=CV_CAT.CODE_VALUE  )
  AND  ( ORDERS_CE.ORDER_ID=CLINICAL_EVENT.ORDER_ID  )
  AND  ( ORDERS_CE.ENCNTR_ID=CLINICAL_EVENT.ENCNTR_ID  )
  AND  ( CLINICAL_EVENT.RESOURCE_CD=CV_SERV_RES.CODE_VALUE  )
  AND  ( RESOURCE_GROUP_SUB.CHILD_SERVICE_RESOURCE_CD=CLINICAL_EVENT.RESOURCE_CD  )
  AND  ( RESOURCE_GROUP_SUB.PARENT_SERVICE_RESOURCE_CD=RESOURCE_GROUP_SEC.CHILD_SERVICE_RESOURCE_CD  )
  AND  ( RESOURCE_GROUP_SEC.PARENT_SERVICE_RESOURCE_CD=CV_RES_GRP_SEC.CODE_VALUE  )
  AND  ( ENCNTR_LOC_HIST.ACTIVE_IND = 1
  )
  AND  ( ENCOUNTER.ACTIVE_IND = 1  )
  AND  ( ENCNTR_LOC_HIST.BEG_EFFECTIVE_DT_TM = (
     SELECT MIN(ELH.BEG_EFFECTIVE_DT_TM)
     FROM ENCNTR_LOC_HIST ELH
     WHERE ELH.ENCNTR_ID = ENCNTR_LOC_HIST.ENCNTR_ID
     AND ELH.ACTIVE_IND = 1)  )
  AND  
  (
   ENCOUNTER.ENCNTR_TYPE_CD  IN  ( 309308, 309312, 174985471  )
   AND
   ENCOUNTER.REG_DT_TM  BETWEEN  '01-01-2024 00:00:00'  AND  '01-01-2025 00:00:00'
   AND
   CV_EVENT.DISPLAY  =  'Calcium blood'
   AND
   CLINICAL_EVENT.VALID_UNTIL_DT_TM  >  pi_to_gmt(TRUNC(SYSDATE),( pi_time_zone(2,@Variable('BOUSER')) ))
  )
/* @Variable('UNVNAME') - @Variable('BOUSER') - @Variable('DOCNAME') */



/* Denominator Script */

SELECT
  CV_FAC_HIST.DISPLAY,
  ENCOUNTER.ENCNTR_ID,
  pi_from_gmt(ENCOUNTER.REG_DT_TM,( @Prompt('Choose Time Zone','A','Relative Dates\TZ Prompt List',mono,free,persistent,{' '},) )),
  pi_from_gmt(ENCOUNTER.DISCH_DT_TM,( @Prompt('Choose Time Zone','A','Relative Dates\TZ Prompt List',mono,free,persistent,{' '},) ))
FROM
  CODE_VALUE  CV_FAC_HIST,
  ENCNTR_LOC_HIST,
  ENCOUNTER,
  CODE_VALUE  CV_ENCOUTER_TYPE
WHERE
  ( ENCOUNTER.ENCNTR_TYPE_CD=CV_ENCOUTER_TYPE.CODE_VALUE AND ENCOUNTER.ACTIVE_IND = 1  )
  AND  ( ENCOUNTER.ENCNTR_ID=ENCNTR_LOC_HIST.ENCNTR_ID AND ENCOUNTER.ACTIVE_IND = 1  )
  AND  ( ENCNTR_LOC_HIST.LOC_FACILITY_CD=CV_FAC_HIST.CODE_VALUE  )
  AND  ( ENCNTR_LOC_HIST.ACTIVE_IND = 1
  )
  AND  ( ENCOUNTER.ACTIVE_IND = 1  )
  AND  ( ENCNTR_LOC_HIST.BEG_EFFECTIVE_DT_TM = (
     SELECT MIN(ELH.BEG_EFFECTIVE_DT_TM)
     FROM ENCNTR_LOC_HIST ELH
     WHERE ELH.ENCNTR_ID = ENCNTR_LOC_HIST.ENCNTR_ID
     AND ELH.ACTIVE_IND = 1)  )
  AND  
  (
   ENCOUNTER.REG_DT_TM  BETWEEN  '01-01-2024 00:00:00'  AND  '01-01-2025 00:00:00'
   AND
   ENCOUNTER.ENCNTR_TYPE_CD  IN  ( 309308, 309312, 174985471  )
  )
/* @Variable('UNVNAME') - @Variable('BOUSER') - @Variable('DOCNAME') */
